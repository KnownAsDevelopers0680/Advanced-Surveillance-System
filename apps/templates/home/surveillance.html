{% extends 'layouts/base.html' %}

{% block title %}
Surveillance System
{% endblock title %}

{% block stylesheets %}
<style>
  .text-dark-green {
    color: #07a907; /* Dark green color */
  }
  .video-container {
    position: relative;
    overflow: hidden;
    width: 100%; /* Ensure it takes full width */
    height: auto;
  }
  .video-container img {
    width: 100%;
    height: auto;
    object-fit: cover;
  }
  .card {
    border-left: 20px solid transparent;
    border-right: 20px solid transparent;
    margin-bottom: 20px;
  }
  .card-body {
    padding: 15px;
  }
  .content-container {
    min-height: 100vh;
  }
  .timestamp-container {
    text-align: center;
    margin-top: 15px;
  }
  .buttons-container {
    margin-top: 20px;
    text-align: center;
  }
  .btn {
    margin: 0 10px;
  }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="container content-container">
  <h5 class="text-center">Surveillance System</h5>
  <p class="text-center font-weight-bold">
    Instantly detect and respond to incidents such as equipment malfunctions,
    split oil, or the absence of critical safety gear like helmets.
  </p>
  <br>

  <!-- Video Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="video-container" style="position: relative; overflow: hidden;">
          <video autoplay loop muted style="width: 1200px; height: 290px; object-fit:fill; opacity: 0; transition: opacity 2s ease-in;" onloadeddata="this.style.opacity='1';">
            <source src="../../static/assets/video/SurveilX-Security2.mp4" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>
      </div>
    </div>
  
  <!-- Video Section -->
  <div class="container text-center">
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body p-3">
            <h5 class="font-weight-bolder mb-0">Live Footage:</h5>
            <p class="text-sm mb-0 font-weight-bold">Camera Name:</p>
            <div class="video-container" style="max-width: 90%; overflow: hidden;">
              <img id="liveFootage" src="/video_feed" alt="Live Footage" style="width: 90%; height: auto;">
            </div>
            <p class="text-sm mb-0 font-weight-bold timestamp-container">
              Timestamp: <span id="currentTimestamp"></span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Camera Control Section -->
  <div class="container text-center">
    <div class="row">
      <div class="col-xl-5 col-sm-12 mb-xl-0 mb-4">
        <div class="card">
          <div class="card-body p-3">
            <h5 class="font-weight-bolder mb-0 text-center">Camera Credentials:</h5>
            <!-- Button to start and stop the camera -->
            <div class="buttons-container text-center">
              <button onclick="startDetection()" class="btn btn-primary">Start Camera</button>
              <button onclick="stopCamera()" class="btn btn-danger">Stop Camera</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <br>

</div>

{% include "includes/footer.html" %}

{% endblock content %}

{% block javascripts %}
<script>
  let videoStream; // Global variable to store the video stream

  async function startCamera() {
    const img = document.querySelector("#liveFootage"); // Select the img element
    const constraints = { video: true }; // Video stream constraints

    try {
      videoStream = await navigator.mediaDevices.getUserMedia(constraints); // Access the camera

      // Use a canvas to capture frames from the video stream and update the img element
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      const videoTrack = videoStream.getVideoTracks()[0];
      const videoTrackSettings = videoTrack.getSettings();
      canvas.width = videoTrackSettings.width;
      canvas.height = videoTrackSettings.height;

      function updateImage() {
        context.drawImage(videoStream, 0, 0, canvas.width, canvas.height); // Draw the current frame onto the canvas
        img.src = canvas.toDataURL('image/jpeg'); // Set the img source to the canvas frame as a data URL
      }

      // Start periodically updating the image
      setInterval(updateImage, 1000); // Update every second

      img.style.opacity = "1"; // Make the image visible
      alert("Camera started successfully!"); // Notify the user
    } catch (error) {
      console.error("Error accessing the camera:", error);
      alert("Failed to start the camera. Please check your device permissions.");
    }
  }

  function startDetection() {
    alert("Detection started! Ensure the camera is connected.");
    startCamera(); // Start the camera
  }

  function updateTimestamp() {
    const timestampElement = document.getElementById("currentTimestamp");
    const now = new Date(); // Get the current date and time
    const formattedTimestamp = now.toLocaleString(); // Format it as per local settings
    timestampElement.textContent = formattedTimestamp; // Set the timestamp in the span
  }

  // Update the timestamp every second
  setInterval(updateTimestamp, 1000);
</script>
{% endblock javascripts %}
